<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarsFlow English Academy</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Paleta Oficial MarsFlow */
            --mars-navy: #00205B;      /* Azul Marinho Profundo */
            --mars-navy-hover: #001540;
            --mars-red: #C8102E;       /* Vermelho Carmesim */
            --mars-red-hover: #a50b23;
            --mars-gold: #D4AF37;      /* Dourado Met√°lico */
            --text-dark: #1a1a1a;
            --text-muted: #666666;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--mars-navy) 0%, #000814 100%);
            min-height: 100vh;
            color: var(--text-dark);
            margin: 0;
            padding-bottom: 60px;
        }
        
        /* --- UTILIT√ÅRIOS DE COR --- */
        .text-mars-navy { color: var(--mars-navy) !important; }
        .text-mars-red { color: var(--mars-red) !important; }
        .text-mars-gold { color: var(--mars-gold) !important; }
        .bg-mars-navy { background-color: var(--mars-navy) !important; color: white; }
        .bg-mars-red { background-color: var(--mars-red) !important; color: white; }

        /* --- CART√ïES --- */
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            background-color: #ffffff;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 18px 24px;
            font-weight: 700;
            color: var(--mars-navy);
            border-radius: 16px 16px 0 0 !important;
        }

        /* --- NAVBAR MELHORADA --- */
        .navbar {
            background-color: var(--mars-navy) !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            padding: 12px 0;
        }
        .navbar-brand { font-weight: 800; letter-spacing: 1px; font-size: 1.4rem; }
        
        .nav-link { 
            color: rgba(255,255,255,0.8) !important; 
            font-weight: 500; 
            transition: all 0.3s ease; 
            margin: 0 5px;
            border-radius: 8px;
            padding: 8px 16px !important;
        }
        /* Hover e Active na Navbar */
        .nav-link:hover { 
            background-color: rgba(255,255,255,0.1); 
            color: white !important; 
            transform: translateY(-2px);
        }
        .nav-link.active { 
            background-color: var(--mars-red); /* Destaque Vermelho */
            color: white !important; 
            font-weight: 700; 
            box-shadow: 0 4px 10px rgba(200, 16, 46, 0.4);
        }

        /* --- ABAS DO RANKING (CORRIGIDO) --- */
        .nav-tabs .nav-link {
            color: rgba(255,255,255,0.6) !important; /* Texto inativo claro */
            border: none;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            font-weight: 600;
        }
        .nav-tabs .nav-link:hover {
            color: white !important;
            background-color: rgba(255,255,255,0.1);
        }
        .nav-tabs .nav-link.active {
            background-color: var(--mars-red) !important; /* Aba ativa Vermelha */
            color: white !important;
            border: none;
        }

        /* --- PERFIL (LEVEL CORRIGIDO) --- */
        .level-badge {
            position: absolute;
            bottom: -10px; /* Posiciona bem no limite */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--mars-red);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            border: 3px solid white; /* Borda branca para destacar da foto */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
            white-space: nowrap;
        }

        /* --- BADGES GERAIS --- */
        .badge-role {
            background-color: rgba(255,255,255,0.2);
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 8px;
            vertical-align: middle;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        /* --- INPUTS & FORMS --- */
        .form-control, .form-select {
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            color: var(--mars-navy);
        }
        .form-control:focus, .form-select:focus {
            background-color: #fff;
            border-color: var(--mars-navy);
            box-shadow: 0 0 0 4px rgba(0, 32, 91, 0.1);
        }

        /* --- LOGIN --- */
        .login-container {
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            padding: 40px;
            margin-top: 60px;
            border-top: 8px solid var(--mars-red);
        }
        
        /* Bot√µes */
        .btn-primary { background-color: var(--mars-navy); border-color: var(--mars-navy); }
        .btn-primary:hover { background-color: var(--mars-navy-hover); transform: translateY(-2px); }
        .btn-danger { background-color: var(--mars-red); border-color: var(--mars-red); }
        .btn-danger:hover { background-color: var(--mars-red-hover); transform: translateY(-2px); }

        .content-section { display: none; }
        .hover-effect { cursor: pointer; transition: transform 0.2s; }
        .hover-effect:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
        
        #simulationBar { background-color: var(--mars-gold); color: var(--mars-navy); border-top: 4px solid var(--mars-navy); }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <div class="row justify-content-center">
            <div class="col-md-5 col-lg-4">
                <div class="login-container text-center">
                    <div class="mb-4">
                        <img src="img/logo.png" alt="Logo" style="max-height: 100px; width: auto;" class="mb-3">
                        <h1 class="text-mars-navy fw-bold" style="letter-spacing: 1px;">MarsFlow</h1>
                        <p class="text-mars-red fw-bold small text-uppercase" style="letter-spacing: 2px;">English Academy</p>
                    </div>
                    <form id="loginForm" class="text-start mt-4">
                        <div class="mb-3">
                            <label class="form-label text-mars-navy fw-bold small">USU√ÅRIO</label>
                            <input type="text" class="form-control" id="loginUser" required placeholder="Ex: pedro.h">
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-mars-navy fw-bold small">SENHA</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-danger btn-lg fw-bold shadow">ACESSAR</button>
                        </div>
                        <div class="text-center mt-3" style="display:none;" id="loadingSpinner">
                            <div class="spinner-border text-mars-navy" role="status"></div>
                        </div>
                        <div id="loginError" class="alert alert-danger mt-3 small border-0" style="display: none;"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="appScreen" style="display: none;">
        
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="#" onclick="showHome()">
                    <img src="img/logo.png" alt="MF" height="35" class="me-2 d-inline-block align-text-top bg-white rounded-circle p-1">
                    <span>MarsFlow</span>
                </a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto ms-lg-3">
                        <li class="nav-item"><a class="nav-link" href="#" onclick="showHome()" id="linkHome">Home</a></li>
                        
                        <li class="nav-item nav-student"><a class="nav-link" href="#" onclick="showGames()" id="linkGames">Jogos</a></li>
                        <li class="nav-item nav-student"><a class="nav-link" href="#" onclick="showStore()" id="linkStore">Loja</a></li>
                        <li class="nav-item nav-student"><a class="nav-link" href="#" onclick="showTasks()" id="linkTasks">Tarefas</a></li>
                        <li class="nav-item nav-student"><a class="nav-link" href="#" onclick="showRanking()" id="linkRanking">Ranking</a></li>

                        <li class="nav-item nav-parent"><a class="nav-link" href="#" onclick="showMessages()" id="linkMessages">Falar com Escola</a></li>

                        <li class="nav-item"><a class="nav-link text-warning fw-bold" href="#" onclick="showAdmin()" id="navAdminBtn">Professor</a></li>
                        <li class="nav-item"><a class="nav-link text-danger fw-bold" href="#" onclick="showDev()" id="navDevBtn">DEV</a></li>
                    </ul>
                    
                    <ul class="navbar-nav align-items-center">
                        <li class="nav-item me-3 position-relative">
                            <a class="nav-link" href="#" onclick="showNotifications()">
                                <i class="fas fa-bell"></i>
                                <span id="notifBadge" class="position-absolute badge-mars rounded-circle" style="display: none; width: 10px; height: 10px; bottom: 12px; right: 4px;"></span>
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <span id="userName" class="fw-bold text-white small">Aluno</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end mt-2 shadow border-0">
                                <li><a class="dropdown-item nav-student" href="#" onclick="showProfile()"><i class="fas fa-id-card me-2 text-mars-navy"></i>Meu Perfil</a></li>
                                <li><a class="dropdown-item nav-parent" href="#" onclick="showMessages()"><i class="fas fa-envelope me-2 text-mars-navy"></i>Mensagens</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            
            <div id="homeContent" class="content-section">
                <div id="dash-student" class="role-dashboard">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card mb-4 border-0 text-white" style="background: linear-gradient(135deg, var(--mars-navy) 0%, #001030 100%);">
                                <div class="card-body p-4 d-flex align-items-center">
                                    <div class="me-4 position-relative">
                                        <div id="homeStudentAvatar" class="display-3 bg-white rounded-circle border border-4 border-white p-1" style="width: 100px; height: 100px; background-size: cover; background-position: center;">üë§</div>
                                        <div class="level-badge bg-mars-red shadow">Lvl <span id="homeStudentLevel">1</span></div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h2 class="fw-bold mb-0">Hi, <span id="homeStudentName">Student</span>! üöÄ</h2>
                                        <div class="progress mt-3" style="height: 10px; background-color: rgba(255,255,255,0.2);">
                                            <div id="homeStudentXPBar" class="progress-bar bg-danger" style="width: 0%"></div>
                                        </div>
                                        <small class="text-white-50 fw-bold"><span id="homeStudentXP">0</span> XP Total</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <div class="card h-100 border-start border-4 border-danger"> <div class="card-body d-flex align-items-center">
                                            <i class="fas fa-coins fa-3x text-mars-red me-3"></i>
                                            <div><h3 class="mb-0 fw-bold text-mars-navy" id="homeStudentCoins">0</h3><small class="text-muted fw-bold">MARS COINS</small></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100 border-start border-4 border-danger bg-light hover-effect" onclick="showTasks()">
                                        <div class="card-body d-flex align-items-center">
                                            <i class="fas fa-star fa-3x text-mars-red me-3"></i>
                                            <div><h3 class="mb-0 fw-bold text-mars-navy" id="homeStudentTasks">0</h3><small class="text-muted fw-bold">MISS√ïES PENDENTES</small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header bg-mars-navy text-white fw-bold"><i class="fas fa-trophy me-2"></i>Top Alunos</div>
                                <div class="card-body p-0"><div id="homeTopStudents" class="list-group list-group-flush"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dash-teacher" class="role-dashboard" style="display:none;">
                    <h2 class="text-white mb-4">Painel Professor</h2>
                    <div class="row g-3">
                        <div class="col-md-4"><div class="card h-100 border-start border-4 border-danger" onclick="showAdminTab('tasks'); showAdmin();"><div class="card-body"><h6>CORRE√á√ïES</h6><h2 id="dashTeacherSubs">0</h2></div></div></div>
                        <div class="col-md-4"><div class="card h-100 border-start border-4 border-primary" onclick="showAdminTab('store'); showAdmin();"><div class="card-body"><h6>PEDIDOS</h6><h2 id="dashTeacherOrders">0</h2></div></div></div>
                        <div class="col-md-4"><div class="card h-100 border-start border-4 border-info" onclick="showAdminTab('classes'); showAdmin();"><div class="card-body"><h6>FOTOS</h6><h2 id="dashTeacherPhotos">0</h2></div></div></div>
                    </div>
                </div>
                <div id="dash-parent" class="role-dashboard" style="display:none;"><div class="alert bg-mars-navy text-white">√Årea do Respons√°vel</div><div class="card text-center"><div class="card-body"><h3 id="dashParentChildName">Filho</h3><button class="btn btn-primary mt-3" onclick="showMessages()">Falar com Escola</button></div></div></div>
                <div id="dash-dev" class="role-dashboard" style="display:none;"><h2 class="text-danger">>_ ROOT</h2><div class="row"><div class="col-md-6"><button class="btn btn-outline-danger w-100 py-4" onclick="showDev()">User Factory</button></div><div class="col-md-6"><button class="btn btn-outline-light w-100 py-4" onclick="showDevTab('simulator'); showDev();">Simulador</button></div></div></div>
            </div>

            <div id="gamesContent" class="content-section">
                <div class="card"><div class="card-header bg-mars-navy">Jogos</div><div class="card-body text-center"><div class="row"><div class="col-md-4"><div class="card p-4 hover-effect"><i class="fas fa-brain fa-3x text-mars-red mb-3"></i><h5>Quiz</h5><button class="btn btn-primary rounded-pill w-100" onclick="window.location.href='quiz.html'">JOGAR</button></div></div></div></div></div>
            </div>

            <div id="storeContent" class="content-section">
                <div class="d-flex justify-content-between mb-4"><h2 class="text-white">Loja</h2><div class="bg-white p-2 px-4 rounded-pill"><span class="h4 text-mars-gold fw-bold" id="storeBalance">0</span></div></div>
                <div class="row" id="storeList"></div>
            </div>

            <div id="tasksContent" class="content-section">
                <div class="row"><div class="col-md-8"><div class="card"><div class="card-header bg-mars-navy text-white d-flex justify-content-between"><span>Miss√µes</span><span class="badge bg-white text-mars-navy" id="taskCount">0</span></div><div class="card-body p-0"><div id="taskList" class="list-group list-group-flush"></div></div></div></div><div class="col-md-4"><div class="card bg-mars-red text-white"><div class="card-body text-center"><h5>Ganhe XP!</h5><p>Fa√ßa as tarefas.</p></div></div></div></div>
            </div>

            <div id="rankingContent" class="content-section">
                <div class="card">
                    <div class="card-header bg-mars-navy pt-3 pb-0">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0 text-white"><i class="fas fa-trophy text-mars-gold me-2"></i>Classifica√ß√£o</h5>
                            <span class="badge bg-light text-mars-navy" id="myClassBadge">...</span>
                        </div>
                        <ul class="nav nav-tabs border-bottom-0">
                            <li class="nav-item"><a class="nav-link active" id="tabGeneral" href="#" onclick="switchRanking('general')">Geral</a></li>
                            <li class="nav-item"><a class="nav-link" id="tabClass" href="#" onclick="switchRanking('class')">Minha Turma</a></li>
                        </ul>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="bg-light text-mars-navy"><tr><th class="text-center">#</th><th>Aluno</th><th class="text-center">Lvl</th><th class="text-end pe-4">XP</th></tr></thead>
                                <tbody id="tabelaRankingCompleta"><tr><td colspan="4" class="text-center p-4">Carregando...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="profileContent" class="content-section">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card shadow border-0" id="profileCard">
                            <div class="card-body text-center pt-5 pb-4">
                                <div class="mb-4 position-relative d-inline-block">
                                    <div id="profileAvatarDisplay" class="display-1 bg-light rounded-circle border border-4 border-white shadow-sm p-1 position-relative overflow-hidden" 
                                         style="width: 140px; height: 140px; background-size: cover; background-position: center;">üë§</div>
                                    <label for="photoUpload" class="position-absolute top-0 end-0 btn btn-sm btn-light rounded-circle border shadow-sm" style="cursor: pointer;"><i class="fas fa-camera text-mars-navy"></i></label>
                                    <input type="file" id="photoUpload" style="display: none;" onchange="handlePhotoUpload(this)">
                                    
                                    <div class="level-badge">Lvl <span id="profileLevel">1</span></div>
                                </div>
                                
                                <div id="photoStatusBadge" class="mb-2"></div>
                                <h3 class="mt-3 fw-bold text-mars-navy" id="profileName">...</h3>
                                <div class="px-4 mb-3"><p class="text-muted small fst-italic" id="profileBioDisplay">"..."</p><button class="btn btn-link btn-sm text-danger" onclick="editBio()">Editar Bio</button><div id="bioEditContainer" style="display:none;" class="mt-2"><textarea id="bioInput" class="form-control form-control-sm mb-2" rows="2"></textarea><button class="btn btn-danger btn-sm w-100" onclick="saveBio()">Salvar</button></div></div>
                                <p class="text-muted mb-2 fw-bold" id="profileClass">...</p>
                                <div class="mt-4 px-3"><div class="d-flex justify-content-between small text-muted mb-1"><span>Progresso</span><span id="xpRatio">0/100</span></div><div class="progress" style="height: 8px;"><div id="xpBar" class="progress-bar bg-mars-red" style="width: 0%"></div></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8"><div class="card shadow-sm h-100"><div class="card-header bg-white text-mars-navy">Invent√°rio</div><div class="card-body bg-light"><div class="row g-3" id="inventoryList"></div></div></div></div>
                </div>
            </div>

            <div id="adminContent" class="content-section"><div class="row h-100"><div class="col-md-3 mb-4"><div class="card h-100 border-0"><div class="card-header bg-mars-navy text-white text-center py-4"><h5 class="mb-0">Professor</h5></div><div class="list-group list-group-flush" id="adminSidebar"><button class="list-group-item list-group-item-action fw-bold py-3" onclick="showAdminTab('tasks')">Atividades</button><button class="list-group-item list-group-item-action fw-bold py-3" onclick="showAdminTab('store')">Loja</button><button class="list-group-item list-group-item-action fw-bold py-3" onclick="showAdminTab('classes')">Turmas</button><button class="list-group-item list-group-item-action fw-bold py-3" onclick="showAdminTab('comms')">Comunica√ß√£o</button></div></div></div><div class="col-md-9"><div id="adminTab-tasks" class="admin-tab"></div><div id="adminTab-store" class="admin-tab" style="display:none;"></div><div id="adminTab-classes" class="admin-tab" style="display:none;"></div><div id="adminTab-comms" class="admin-tab" style="display:none;"></div></div></div></div>
            <div id="devContent" class="content-section"><div class="row h-100"><div class="col-md-3"><div class="card border-danger h-100"><div class="card-header bg-danger text-white text-center"><h5>DEV</h5></div><div class="list-group list-group-flush" id="devSidebar"><button class="list-group-item active" onclick="showDevTab('users')">Users</button><button class="list-group-item" onclick="showDevTab('store')">Loja</button><button class="list-group-item text-primary" onclick="showDevTab('simulator')">Simular</button></div></div></div><div class="col-md-9"><div id="devTab-users" class="dev-tab"></div><div id="devTab-store" class="dev-tab" style="display:none;"></div><div id="devTab-simulator" class="dev-tab" style="display:none;"></div></div></div></div>
            <div id="messagesContent" class="content-section"><div class="row"><div class="col-md-5"><div class="card"><div class="card-header bg-mars-navy text-white">Nova Mensagem</div><div class="card-body"><form onsubmit="event.preventDefault(); sendMessage();"><select id="msgSubject" class="form-select mb-3"><option>D√∫vida</option><option>Outros</option></select><textarea id="msgContent" class="form-control mb-3" rows="5"></textarea><button class="btn btn-primary w-100">ENVIAR</button></form></div></div></div><div class="col-md-7"><div class="card"><div class="card-header">Hist√≥rico</div><div class="card-body p-0"><div id="myMessagesList"></div></div></div></div></div></div>
            <div id="notificationsContent" class="content-section"><div class="row h-100"><div class="col-md-4 border-end"><div class="list-group list-group-flush" id="notifList"></div></div><div class="col-md-8"><div id="notifDetail" class="p-5 text-center text-muted">Selecione...</div></div></div></div>

        </div>
    </div>

    <div id="simulationBar" class="fixed-bottom text-center py-2 fw-bold shadow" style="display: none; z-index: 9999;">
        <i class="fas fa-glasses me-2"></i> MODO SIMULA√á√ÉO: <span id="simRoleName"></span>
        <button class="btn btn-sm btn-light ms-3 fw-bold border-0 text-mars-navy" onclick="activateSimulation('dev')">SAIR</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, collection, query, orderBy, limit, getDocs, where, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configura√ß√£o
        const firebaseConfig = {
          apiKey: "AIzaSyBYe4oRa-uS1hTodVAsa7Zer1fOAU9-kcA",
          authDomain: "marsflow-english-academy.firebaseapp.com",
          projectId: "marsflow-english-academy",
          storageBucket: "marsflow-english-academy.firebasestorage.app",
          messagingSenderId: "527381031956",
          appId: "1:527381031956:web:495fb3da0a3cea8b864b01",
          measurementId: "G-1NC30HNJLQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.db = db; window.auth = auth;
        window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; window.updateDoc = updateDoc; window.addDoc = addDoc; window.deleteDoc = deleteDoc;
        window.arrayUnion = arrayUnion; window.arrayRemove = arrayRemove;
        window.collection = collection; window.query = query; window.orderBy = orderBy; window.limit = limit; window.getDocs = getDocs; window.where = where; window.getCountFromServer = getCountFromServer;

        let currentUser = null;
        let userData = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(); 
                showAppScreen();
                if (window.initializeApp) window.initializeApp();
                if(window.checkNotifications) setInterval(() => window.checkNotifications(), 60000);
            } else {
                showLoginScreen();
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            let loginUser = document.getElementById('loginUser').value.trim();
            const password = document.getElementById('password').value;
            if (!loginUser.includes('@')) loginUser += '@aluno.marsflow';
            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                await signInWithEmailAndPassword(auth, loginUser, password);
                document.getElementById('loadingSpinner').style.display = 'none';
            } catch (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('errorMessage').innerText = "Login inv√°lido.";
            }
        });

        async function loadUserData() {
            if (!currentUser) return;
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                } else {
                    const emailKey = currentUser.email.toLowerCase();
                    const preRegDoc = await getDoc(doc(db, "pre_registers", emailKey));
                    let initialData = {};
                    if (preRegDoc.exists()) {
                        initialData = preRegDoc.data();
                        delete initialData.isPreRegistered;
                    } else {
                        initialData = { name: currentUser.email.split('@')[0], role: 'student', level: 1, coins: 50, experience: 0 };
                    }
                    userData = { ...initialData, uid: currentUser.uid, email: currentUser.email, inventory: [], createdAt: new Date().toISOString() };
                    await setDoc(doc(db, 'users', currentUser.uid), userData);
                }
                window.userData = userData;
                updateUserInterface();
            } catch (error) { console.error('Erro load user:', error); }
        }

        function updateUserInterface() {
            if (!userData) return;
            const icon = userData.equippedIcon || '';
            // --- TAG DE PERFIL NA NAVBAR ---
            const roleLabels = {'student': 'Aluno', 'teacher': 'Professor', 'parent': 'Respons√°vel', 'admin': 'Admin'};
            const roleName = roleLabels[userData.role] || 'Usu√°rio';
            
            document.getElementById('userName').innerHTML = `${icon} ${userData.name} <span class="badge-role">${roleName}</span>`;
            
            const role = userData.role; 
            const isDev = (currentUser.email === 'fmartimr@gmail.com');
            
            document.querySelectorAll('.nav-student').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-parent').forEach(el => el.style.display = 'none');
            document.getElementById('navAdminBtn').style.display = 'none';
            document.getElementById('navDevBtn').style.display = 'none';

            if (isDev) {
                document.querySelectorAll('.nav-student').forEach(el => el.style.display = 'block');
                document.getElementById('navAdminBtn').style.display = 'block';
                document.getElementById('navDevBtn').style.display = 'block';
            } 
            else if (role === 'teacher' || role === 'admin') {
                document.getElementById('navAdminBtn').style.display = 'block';
                document.querySelectorAll('.nav-student').forEach(el => el.style.display = 'block');
            } 
            else if (role === 'parent') {
                document.querySelectorAll('.nav-parent').forEach(el => el.style.display = 'block');
            } 
            else {
                document.querySelectorAll('.nav-student').forEach(el => el.style.display = 'block');
            }

            if (role === 'teacher' || role === 'admin' || isDev) {
                if(window.loadPendingPhotos) window.loadPendingPhotos();
            }
        }

        window.logout = async function() { await signOut(auth); window.location.reload(); };
        window.showLoginScreen = () => { document.getElementById('loginScreen').style.display='block'; document.getElementById('appScreen').style.display='none'; }
        window.showAppScreen = () => { document.getElementById('loginScreen').style.display='none'; document.getElementById('appScreen').style.display='block'; window.showHome(); }
        window.hideAllSections = () => { document.querySelectorAll('.content-section').forEach(s => s.style.display='none'); }

        // Fun√ß√£o Helper para marcar Navbar
        function setActiveNav(id) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const el = document.getElementById(id);
            if(el) el.classList.add('active');
        }

        window.showHome = () => { 
            hideAllSections(); 
            document.getElementById('homeContent').style.display='block'; 
            setActiveNav('linkHome');
            
            const role = window.userData.role;
            const isDev = (window.auth.currentUser.email === 'fmartimr@gmail.com');
            document.querySelectorAll('.role-dashboard').forEach(el => el.style.display = 'none');

            if (isDev && !window.originalRole) { 
                document.getElementById('dash-dev').style.display = 'block';
                if(window.loadDevStats) window.loadDevStats();
            } else if (role === 'teacher') {
                document.getElementById('dash-teacher').style.display = 'block';
                if(window.loadTeacherDashboard) window.loadTeacherDashboard();
            } else if (role === 'parent') {
                document.getElementById('dash-parent').style.display = 'block';
                if(window.loadParentDashboard) window.loadParentDashboard();
            } else {
                document.getElementById('dash-student').style.display = 'block';
                if(window.loadStudentDashboard) window.loadStudentDashboard();
            }
        };

        window.showGames = () => { hideAllSections(); document.getElementById('gamesContent').style.display='block'; setActiveNav('linkGames'); };
        window.showStore = () => { hideAllSections(); document.getElementById('storeContent').style.display='block'; setActiveNav('linkStore'); if(window.loadStore) window.loadStore(); };
        window.showTasks = () => { hideAllSections(); document.getElementById('tasksContent').style.display='block'; setActiveNav('linkTasks'); if(window.loadTasks) window.loadTasks(); };
        window.showRanking = () => { hideAllSections(); document.getElementById('rankingContent').style.display='block'; setActiveNav('linkRanking'); if(window.loadRealRanking) window.loadRealRanking(); };
        window.showProfile = () => { hideAllSections(); document.getElementById('profileContent').style.display = 'block'; setActiveNav(''); if(window.loadProfile) window.loadProfile(); };
        window.showMessages = () => { hideAllSections(); document.getElementById('messagesContent').style.display = 'block'; setActiveNav('linkMessages'); if(window.loadMyMessages) window.loadMyMessages(); };
        
        window.showAdmin = () => {
            hideAllSections();
            document.getElementById('adminContent').style.display = 'block';
            setActiveNav('navAdminBtn');
            if(window.showAdminTab) window.showAdminTab('tasks');
        };

        window.showNotifications = () => {
            hideAllSections();
            document.getElementById('notificationsContent').style.display = 'block';
            setActiveNav('');
            if(window.loadNotificationsScreen) window.loadNotificationsScreen();
        };
        
        window.showDev = function() {
             hideAllSections();
             document.getElementById('devContent').style.display = 'block';
             setActiveNav('navDevBtn');
             if(window.showDevTab) window.showDevTab('users');
        }

    </script>
    <script src="js/app.js"></script>
</body>
</html>
