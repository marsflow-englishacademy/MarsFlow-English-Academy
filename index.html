<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub Gamificado - Escola</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            padding: 40px;
            margin-top: 50px;
            backdrop-filter: blur(10px);
        }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo i {
            font-size: 60px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            color: white;
            backdrop-filter: blur(10px);
        }
        .feature-card i { font-size: 40px; margin-bottom: 15px; color: #fff; }
        .loading-spinner { display: none; text-align: center; margin-top: 20px; }
        .content-section { display: none; } /* Esconde todas as se√ß√µes por padr√£o */
    </style>
</head>
<body>
    <div id="loginScreen" class="container">
        <div class="row justify-content-center">
            <div class="col-md-5">
                <div class="login-container">
                    <div class="logo">
                        <i class="fas fa-graduation-cap"></i>
                        <h1>Hub Gamificado</h1>
                        <p class="text-muted">Sua escola virtual</p>
                    </div>
                    
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label"><i class="fas fa-envelope me-2"></i>Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-4">
                            <label for="password" class="form-label"><i class="fas fa-lock me-2"></i>Senha</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-sign-in-alt me-2"></i>Entrar</button>
                        </div>
                        <div class="text-center">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="guestLogin()">Entrar como Convidado</button>
                        </div>
                        
                        <div class="loading-spinner" id="loadingSpinner">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Entrando...</p>
                        </div>
                        <div id="loginError" class="alert alert-danger mt-3" style="display: none;">
                            <span id="errorMessage"></span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="appScreen" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
            <div class="container">
                <a class="navbar-brand" href="#" onclick="showHome()">
                    <i class="fas fa-graduation-cap me-2"></i>Hub Gamificado
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item"><a class="nav-link" href="#" onclick="showHome()"><i class="fas fa-home me-1"></i>Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="showGames()"><i class="fas fa-gamepad me-1"></i>Jogos</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="showStore()"><i class="fas fa-store me-1"></i>Loja</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="showTasks()"><i class="fas fa-tasks me-1"></i>Tarefas</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="showRanking()"><i class="fas fa-trophy me-1"></i>Ranking</a></li>
                        
                        <li class="nav-item">
                            <a class="nav-link text-warning" href="#" onclick="showAdmin()" id="navAdminBtn" style="display: none;">
                                <i class="fas fa-user-shield me-1"></i>Professor
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-danger fw-bold" href="#" onclick="showDev()" id="navDevBtn" style="display: none;">
                                <i class="fas fa-code me-1"></i>DEV
                            </a>
                        </li>
                    </ul>
                    
                    <ul class="navbar-nav">
                        <li class="nav-item me-3 position-relative">
                            <a class="nav-link text-white" href="#" onclick="showNotifications()">
                                <i class="fas fa-bell fa-lg"></i>
                                <span id="notifBadge" class="position-absolute bg-danger border border-light rounded-circle" 
                                      style="display: none; width: 12px; height: 12px; bottom: 8px; right: 5px;"></span>
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <span id="userName">Usu√°rio</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="showProfile()"><i class="fas fa-user-cog me-1"></i>Perfil</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>Sair</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            
            <div id="homeContent" class="content-section">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-primary text-white"><h5 class="mb-0">Bem-vindo!</h5></div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3"><div class="card bg-light p-3"><h4 id="userCoins">0</h4><small>Moedas</small></div></div>
                                    <div class="col-md-3"><div class="card bg-light p-3"><h4 id="userXP">0</h4><small>XP</small></div></div>
                                    <div class="col-md-3"><div class="card bg-light p-3"><h4 id="userLevel">1</h4><small>N√≠vel</small></div></div>
                                    <div class="col-md-3"><div class="card bg-light p-3"><h4 id="userRank">-</h4><small>Posi√ß√£o</small></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="card shadow-sm">
                            <div class="card-header"><h5>√öltimas Atividades</h5></div>
                            <div class="card-body" id="activityList"><p class="text-muted">Nenhuma atividade recente.</p></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-success text-white"><h5>Top 5 Alunos</h5></div>
                            <div class="card-body" id="topStudents">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gamesContent" class="content-section">
                <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-gamepad me-2"></i>Jogos Educativos</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 text-center p-3">
                                    <i class="fas fa-question-circle fa-3x text-primary mb-3"></i>
                                    <h5>Quiz</h5>
                                    <button class="btn btn-primary" onclick="window.location.href='quiz.html'">Jogar</button>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 text-center p-3 opacity-50">
                                    <i class="fas fa-puzzle-piece fa-3x text-secondary mb-3"></i>
                                    <h5>Quebra-cabe√ßa</h5><button class="btn btn-secondary" disabled>Em breve</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="storeContent" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-store text-success me-2"></i>Loja</h2>
                    <div class="bg-white p-2 rounded shadow-sm border">
                        <small class="text-muted d-block">Saldo</small>
                        <span class="h4 text-warning fw-bold" id="storeBalance">...</span>
                    </div>
                </div>
                <div class="row" id="storeList"><div class="col-12 text-center p-5">Carregando loja...</div></div>
            </div>

            <div id="tasksContent" class="content-section">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white d-flex justify-content-between">
                                <h5>Quadro de Miss√µes</h5><span class="badge bg-light text-primary" id="taskCount">0</span>
                            </div>
                            <div class="card-body p-0"><div id="taskList" class="list-group list-group-flush">Carregando...</div></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light border-0"><div class="card-body text-center"><i class="fas fa-check-circle fa-3x text-success mb-3"></i><p>Complete miss√µes para ganhar XP!</p></div></div>
                    </div>
                </div>
            </div>

            <div id="rankingContent" class="content-section">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Classifica√ß√£o</h5>
                            <span class="badge bg-dark text-warning" id="myClassBadge">Sem Turma</span>
                        </div>
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><a class="nav-link active fw-bold" id="tabGeneral" href="#" onclick="switchRanking('general')">üèÜ Geral</a></li>
                            <li class="nav-item"><a class="nav-link text-dark" id="tabClass" href="#" onclick="switchRanking('class')">üè´ Minha Turma</a></li>
                        </ul>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-dark"><tr><th class="text-center">#</th><th>Aluno</th><th class="text-center">N√≠vel</th><th class="text-end">XP</th></tr></thead>
                                <tbody id="tabelaRankingCompleta"><tr><td colspan="4" class="text-center p-4">Carregando...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="notificationsContent" class="content-section">
                <div class="row h-100" style="min-height: 500px;">
                    <div class="col-md-4 border-end pe-0">
                        <div class="list-group list-group-flush h-100 overflow-auto" id="notifList">
                            <div class="text-center p-4 text-muted">Carregando avisos...</div>
                        </div>
                    </div>
                    <div class="col-md-8 ps-0">
                        <div id="notifDetail" class="p-4 h-100 bg-white">
                            <div class="text-center text-muted mt-5"><i class="far fa-envelope-open fa-3x mb-3"></i><p>Selecione uma mensagem.</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="profileContent" class="content-section">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card shadow border-0" id="profileCard">
                            <div class="card-body text-center pt-5 pb-4">
                                <div class="mb-3 position-relative d-inline-block">
                                    <div id="profileAvatarDisplay" class="display-1 bg-light rounded-circle border border-3 p-3 position-relative overflow-hidden" 
                                         style="width: 120px; height: 120px; line-height: 1.2; background-size: cover; background-position: center;">üë§</div>
                                    <label for="photoUpload" class="position-absolute bottom-0 end-0 btn btn-sm btn-dark rounded-circle" style="cursor: pointer;" title="Alterar Foto">
                                        <i class="fas fa-camera"></i>
                                    </label>
                                    <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(this)">
                                    <span class="position-absolute top-100 start-50 translate-middle badge rounded-pill bg-primary border border-2 border-white">Lvl <span id="profileLevel">1</span></span>
                                </div>
                                <div id="photoStatusBadge" class="mb-2"></div>

                                <h3 class="mt-3 fw-bold" id="profileName">...</h3>
                                
                                <div class="px-4 mb-3">
                                    <p class="text-muted small mb-1" id="profileBioDisplay">"Sem bio."</p>
                                    <button class="btn btn-link btn-sm text-decoration-none p-0" onclick="editBio()"><i class="fas fa-pen small"></i> Editar</button>
                                    <div id="bioEditContainer" style="display: none;" class="mt-2">
                                        <textarea id="bioInput" class="form-control form-control-sm mb-2" rows="2" maxlength="150"></textarea>
                                        <button class="btn btn-primary btn-sm w-100" onclick="saveBio()">Salvar</button>
                                    </div>
                                </div>

                                <p class="text-muted mb-2" id="profileClass">...</p>
                                <p class="badge bg-warning text-dark" id="profileRole">Aluno</p>
                                <div class="mt-4 px-3">
                                    <div class="d-flex justify-content-between small text-muted mb-1"><span>Progresso</span><span id="xpRatio">0/100</span></div>
                                    <div class="progress" style="height: 10px;"><div id="xpBar" class="progress-bar bg-success" style="width: 0%"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white py-3"><h5 class="mb-0"><i class="fas fa-box-open me-2 text-primary"></i>Invent√°rio</h5></div>
                            <div class="card-body bg-light">
                                <div class="row g-3" id="inventoryList"><div class="col-12 text-center p-5 text-muted">Carregando...</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="adminContent" class="content-section">
                <h2 class="mb-4"><i class="fas fa-user-shield text-danger"></i> Painel do Professor</h2>
                
                <div class="row">
                    <div class="col-md-5">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-danger text-white">Criar Miss√£o</div>
                            <div class="card-body">
                                <form onsubmit="event.preventDefault(); createTask();">
                                    <input type="text" id="taskTitle" class="form-control mb-2" required placeholder="T√≠tulo">
                                    <textarea id="taskDesc" class="form-control mb-2" required placeholder="Descri√ß√£o"></textarea>
                                    <div class="row mb-2">
                                        <div class="col"><input type="number" id="taskXP" class="form-control" placeholder="XP" value="100"></div>
                                        <div class="col"><input type="number" id="taskCoins" class="form-control" placeholder="Coins" value="50"></div>
                                    </div>
                                    <input type="date" id="taskDate" class="form-control mb-2">
                                    <button type="submit" class="btn btn-danger w-100">Publicar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card shadow-sm">
                            <div class="card-header bg-dark text-white d-flex justify-content-between">
                                <span>Entregas Pendentes</span>
                                <button class="btn btn-sm btn-outline-light" onclick="loadPendingSubmissions()">Atualizar</button>
                            </div>
                            <div class="card-body p-0"><div id="submissionsList" class="list-group list-group-flush"><div class="p-3 text-center text-muted">Vazio</div></div></div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm border-success">
                            <div class="card-header bg-success text-white d-flex justify-content-between">
                                <span><i class="fas fa-gift me-2"></i>Pedidos da Loja</span>
                                <button class="btn btn-sm btn-light text-success" onclick="loadPendingOrders()">Atualizar</button>
                            </div>
                            <div class="card-body p-0"><div id="ordersList" class="list-group list-group-flush"></div></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm border-info">
                            <div class="card-header bg-info text-white"><span><i class="fas fa-camera me-2"></i>Aprovar Fotos</span></div>
                            <div class="card-body p-0"><div id="pendingPhotosList" class="list-group list-group-flush"></div></div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                         <div class="card shadow-sm">
                            <div class="card-header bg-dark text-white d-flex justify-content-between">
                                <span><i class="fas fa-history me-2"></i>Hist√≥rico de Resgates</span>
                                <div class="d-flex gap-2">
                                    <select id="historyFilterClass" class="form-select form-select-sm" style="width:150px;" onchange="loadRedemptionHistory()"><option value="all">Todas</option></select>
                                    <button class="btn btn-sm btn-light" onclick="loadRedemptionHistory()">Sync</button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 200px;">
                                    <table class="table table-striped mb-0 text-center small">
                                        <thead><tr><th>Data</th><th>Aluno</th><th>Item</th><th>$</th></tr></thead>
                                        <tbody id="redemptionHistoryBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card shadow-sm border-info">
                            <div class="card-header bg-info text-white d-flex justify-content-between">
                                <span>Minhas Turmas</span>
                                <button class="btn btn-sm btn-light" onclick="createNewClassPrompt()">+</button>
                            </div>
                            <div class="card-body p-0"><div id="classList" class="list-group list-group-flush"></div></div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card shadow-sm border-warning">
                            <div class="card-header bg-warning text-dark">Enviar Comunicado</div>
                            <div class="card-body">
                                <form onsubmit="event.preventDefault(); sendNotification();">
                                    <div class="row mb-2">
                                        <div class="col"><input type="text" id="notifTitle" class="form-control" placeholder="T√≠tulo" required></div>
                                        <div class="col"><select id="notifTarget" class="form-select"></select></div>
                                    </div>
                                    <textarea id="notifMessage" class="form-control mb-2" rows="2" placeholder="Mensagem"></textarea>
                                    <div class="row mb-2">
                                        <div class="col"><select id="notifType" class="form-select"><option value="homework">Homework</option><option value="test">Prova</option><option value="event">Evento</option></select></div>
                                        <div class="col"><select id="notifUrgency" class="form-select"><option value="chill">Tranquilo</option><option value="attention">Aten√ß√£o</option><option value="urgent">Urgente</option></select></div>
                                    </div>
                                    <button type="submit" class="btn btn-warning w-100">Enviar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-8">
                        <div class="card shadow-sm border-primary">
                            <div class="card-header bg-primary text-white">Gerenciar Aluno (Regras/Ajustes)</div>
                            <div class="card-body">
                                <select id="studentSelect" class="form-select mb-3"><option>Carregando...</option></select>
                                <div class="row">
                                    <div class="col-md-6 border-end">
                                        <label class="fw-bold">Regras R√°pidas:</label>
                                        <div id="rulesList" class="d-flex flex-wrap gap-2"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <form onsubmit="event.preventDefault(); applyManualAdjustment();">
                                            <div class="input-group mb-2"><span class="input-group-text">XP</span><input type="number" id="manualXP" class="form-control"></div>
                                            <div class="input-group mb-2"><span class="input-group-text">$</span><input type="number" id="manualCoins" class="form-control"></div>
                                            <button type="submit" class="btn btn-outline-primary w-100">Aplicar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-secondary">
                            <div class="card-header bg-secondary text-white">Criar Regra</div>
                            <div class="card-body">
                                <form onsubmit="event.preventDefault(); createRule();">
                                    <input type="text" id="ruleName" class="form-control mb-2" placeholder="Nome" required>
                                    <div class="row mb-2"><div class="col"><input type="number" id="ruleXP" class="form-control" placeholder="XP"></div><div class="col"><input type="number" id="ruleCoins" class="form-control" placeholder="$"></div></div>
                                    <select id="ruleType" class="form-select mb-2"><option value="positive">Positiva</option><option value="negative">Negativa</option></select>
                                    <button type="submit" class="btn btn-secondary w-100">Salvar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 

            <div id="devContent" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-danger"><i class="fas fa-terminal me-2"></i>Developer Console</h2>
                    <span class="badge bg-danger">Restrito</span>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card shadow-sm border-danger mb-4">
                            <div class="card-header bg-danger text-white">Pr√©-Cadastrar Usu√°rio</div>
                            <div class="card-body">
                                <form onsubmit="event.preventDefault(); createPreRegistry();">
                                    <select id="devUserRole" class="form-select mb-3" onchange="toggleDevFields()">
                                        <option value="student">Aluno</option><option value="teacher">Professor</option><option value="parent">Respons√°vel</option>
                                    </select>
                                    <input type="text" id="devUserName" class="form-control mb-3" placeholder="Nome Completo" required>
                                    <input type="email" id="devUserEmail" class="form-control mb-3" placeholder="Email" required>

                                    <div id="devStudentFields">
                                        <label>Data Nasc.</label><input type="date" id="devUserDOB" class="form-control mb-3">
                                        <label>Turma</label><select id="devUserClass" class="form-select mb-3"></select>
                                    </div>
                                    <div id="devTeacherFields" style="display: none;">
                                        <label>Turmas (Ctrl+Click)</label><select id="devUserClasses" class="form-select mb-3" multiple></select>
                                    </div>
                                    <div id="devParentFields" style="display: none;">
                                        <label>Filhos (Ctrl+Click)</label><select id="devUserChildren" class="form-select mb-3" multiple></select>
                                    </div>
                                    <button type="submit" class="btn btn-outline-danger w-100">Criar Pr√©-Cadastro</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                         <div class="alert alert-info">Use o pr√©-cadastro para criar usu√°rios. Quando eles logarem com o email definido, receber√£o automaticamente a Turma e Perfil configurados.</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, arrayUnion, arrayRemove, collection, query, orderBy, limit, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURA√á√ÉO DO FIREBASE (MANTIDA)
        const firebaseConfig = {
          apiKey: "AIzaSyBYe4oRa-uS1hTodVAsa7Zer1fOAU9-kcA",
          authDomain: "marsflow-english-academy.firebaseapp.com",
          projectId: "marsflow-english-academy",
          storageBucket: "marsflow-english-academy.firebasestorage.app",
          messagingSenderId: "527381031956",
          appId: "1:527381031956:web:495fb3da0a3cea8b864b01",
          measurementId: "G-1NC30HNJLQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Exporta√ß√µes Globais Essenciais
        window.db = db; window.auth = auth;
        window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; window.updateDoc = updateDoc; window.addDoc = addDoc;
        window.arrayUnion = arrayUnion; window.arrayRemove = arrayRemove;
        window.collection = collection; window.query = query; window.orderBy = orderBy; window.limit = limit; window.getDocs = getDocs; window.where = where;

        let currentUser = null;
        let userData = null;

        // AUTH LISTENER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(); // Aqui acontece a m√°gica do pr√©-cadastro
                showAppScreen();
                if (window.initializeApp) window.initializeApp();
                if(window.checkNotifications) setInterval(() => window.checkNotifications(), 60000);
            } else {
                showLoginScreen();
            }
        });

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                document.getElementById('loadingSpinner').style.display = 'block';
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('loadingSpinner').style.display = 'none';
            } catch (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('errorMessage').innerText = "Erro no login: " + error.code;
            }
        });

        window.guestLogin = function() {
            currentUser = { uid: 'guest', email: 'convidado@teste.com' };
            userData = { name: 'Visitante', role: 'student', coins: 100, level: 1 };
            window.userData = userData;
            showAppScreen();
        };

        // CARREGAR DADOS + PR√â-CADASTRO
        async function loadUserData() {
            if (!currentUser) return;
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                
                if (userDoc.exists()) {
                    userData = userDoc.data();
                } else {
                    // L√ìGICA DE PR√â-CADASTRO (Recupera dados criados pelo DEV)
                    const emailKey = currentUser.email.toLowerCase();
                    const preRegDoc = await getDoc(doc(db, "pre_registers", emailKey));
                    
                    let initialData = {};
                    if (preRegDoc.exists()) {
                        console.log("Pr√©-cadastro encontrado!");
                        initialData = preRegDoc.data();
                        delete initialData.isPreRegistered;
                    } else {
                        initialData = { name: currentUser.email.split('@')[0], role: 'student', level: 1, coins: 50, experience: 0 };
                    }

                    userData = {
                        ...initialData,
                        uid: currentUser.uid,
                        email: currentUser.email,
                        inventory: [],
                        createdAt: new Date().toISOString()
                    };
                    await setDoc(doc(db, 'users', currentUser.uid), userData);
                }
                window.userData = userData;
                updateUserInterface();
                
            } catch (error) { console.error('Erro load user:', error); }
        }

        function updateUserInterface() {
            if (!userData) return;
            
            // Icon + Nome
            const icon = userData.equippedIcon || '';
            document.getElementById('userName').innerHTML = `${icon} ${userData.name}`;
            
            // Stats
            document.getElementById('userCoins').innerText = userData.coins || 0;
            document.getElementById('userXP').innerText = userData.experience || 0;
            document.getElementById('userLevel').innerText = userData.level || 1;
            
            // Controle de Menu (RBAC)
            const isAdmin = ['teacher', 'admin', 'developer'].includes(userData.role);
            const isDev = (currentUser.email === 'fmartimr@gmail.com');

            const adminBtn = document.getElementById('navAdminBtn');
            const devBtn = document.getElementById('navDevBtn');

            if(adminBtn) adminBtn.style.display = isAdmin ? 'block' : 'none';
            if(devBtn) devBtn.style.display = isDev ? 'block' : 'none';

            // Carrega dados espec√≠ficos se for professor
            if(isAdmin && window.loadPendingPhotos) window.loadPendingPhotos();
        }

        window.logout = async function() { await signOut(auth); window.location.reload(); };

        // Navega√ß√£o
        window.showLoginScreen = () => { document.getElementById('loginScreen').style.display='block'; document.getElementById('appScreen').style.display='none'; }
        window.showAppScreen = () => { document.getElementById('loginScreen').style.display='none'; document.getElementById('appScreen').style.display='block'; window.showHome(); }
        window.hideAllSections = () => { document.querySelectorAll('.content-section').forEach(s => s.style.display='none'); }

        window.showHome = () => { hideAllSections(); document.getElementById('homeContent').style.display='block'; };
        window.showGames = () => { hideAllSections(); document.getElementById('gamesContent').style.display='block'; };
        window.showStore = () => { hideAllSections(); document.getElementById('storeContent').style.display='block'; if(window.loadStore) window.loadStore(); };
        window.showTasks = () => { hideAllSections(); document.getElementById('tasksContent').style.display='block'; if(window.loadTasks) window.loadTasks(); };
        
        window.showRanking = () => { 
            hideAllSections(); 
            document.getElementById('rankingContent').style.display='block'; 
            if(window.loadRealRanking) window.loadRealRanking(); 
        };

        window.showProfile = () => {
            hideAllSections();
            document.getElementById('profileContent').style.display = 'block';
            if(window.loadProfile) window.loadProfile();
        };

        window.showAdmin = () => {
            hideAllSections();
            document.getElementById('adminContent').style.display = 'block';
            // Carrega tudo do admin
            if(window.loadPendingSubmissions) window.loadPendingSubmissions();
            if(window.loadPendingOrders) window.loadPendingOrders();
            if(window.loadStudentsForAdmin) window.loadStudentsForAdmin();
            if(window.loadRules) window.loadRules();
            if(window.loadTeacherClasses) window.loadTeacherClasses();
            if(window.loadPendingPhotos) window.loadPendingPhotos();
            if(window.loadRedemptionHistory) window.loadRedemptionHistory();
        };

        window.showNotifications = () => {
            hideAllSections();
            document.getElementById('notificationsContent').style.display = 'block';
            if(window.loadNotificationsScreen) window.loadNotificationsScreen();
        };

    </script>
    <script src="js/app.js"></script>
</body>
</html>
